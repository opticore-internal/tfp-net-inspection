# transit 0
# gwlbe 3
# gwlb 4
# appliance 1
# public 2
# mgmt 5

# transit 0
# gwlbe 1
# gwlb 2
# appliance 3
# public 4
# mgmt 5



===== FILE: ./env/dev/inspection.tf =====
module "dev-inspection" {
  source = "../../modules/inspection"
  vpc_cidr_block = var.vpc_cidr_block
  env            = var.env
  vpc_region = data.aws_region.current.id
}

===== FILE: ./env/dev/main.tf =====
terraform {
  required_version = ">= 1.1.0"
  cloud {
    organization = "opticore"
    workspaces {
      name = "tfp-net-inspection-dev"
    }
  }
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 3.0"
    }
  }
}

provider "aws" {
  region  = "eu-west-2"
  profile = "aws-tgw-paloalto"
}

data "aws_region" "current" {}


===== FILE: ./env/dev/variables.tf =====
variable "env" {
  description = "The environment for which the inspection module is being configured."
  type        = string
  default = "dev"  
}

variable "vpc_cidr_block" {
  description = "CIDR block for the inspection VPC."
  type        = string
  default = "10.99.8.0/21"
}



===== FILE: ./modules/inspection/outputs.tf =====
output "vpc_cidr_block" {
  description = "The CIDR block for the inspection VPC."
  value       = aws_vpc.this.cidr_block
}
output "transit_subnet_az_0" {
  description = "The CIDR block for the transit subnet in AZ A."
  value       = aws_subnet.transit_subnet_az_0.cidr_block
}
output "appliance_subnet_az_0" {
  description = "The CIDR block for the appliance subnet in AZ A."
  value       = aws_subnet.appliance_subnet_az_0.cidr_block
}
output "public_subnet_az_0" {
  description = "The CIDR block for the public subnet in AZ A."
  value       = aws_subnet.public_subnet_az_0.cidr_block
}
output "transit_subnet_az_1" {
  description = "The CIDR block for the transit subnet in AZ B."
  value       = aws_subnet.transit_subnet_az_1.cidr_block
}
output "appliance_subnet_az_1" {
  description = "The CIDR block for the appliance subnet in AZ B."
  value       = aws_subnet.appliance_subnet_az_1.cidr_block
}
output "public_subnet_az_1" {
  description = "The CIDR block for the public subnet in AZ B."
  value       = aws_subnet.public_subnet_az_1.cidr_block
}

===== FILE: ./modules/inspection/vpc.tf =====
locals {
  az_a =  cidrsubnet(aws_vpc.this.cidr_block, 1, 0)
  az_b =  cidrsubnet(aws_vpc.this.cidr_block, 1, 1)
}

resource "aws_vpc" "this" {
  cidr_block = var.vpc_cidr_block
  tags       = { Name = "tfp-${var.env}-net-${lookup(var.vpc_region_shortname,var.vpc_region)}-vpc" }
}

resource "aws_subnet" "transit_subnet_az_0" {
  vpc_id            = aws_vpc.this.id
  cidr_block        = cidrsubnet(local.az_a, 6, 0)
  availability_zone = var.vpc_az_list[0]
  tags              = { Name = "tfp-${var.env}-net-vpc-${lookup(var.vpc_az_shortname,var.vpc_az_list[0])}-transit" }
}

resource "aws_subnet" "appliance_subnet_az_0" {
  vpc_id            = aws_vpc.this.id
  cidr_block        = cidrsubnet(local.az_a, 6, 1)
  availability_zone = var.vpc_az_list[0]
  tags              = { Name = "tfp-${var.env}-net-vpc-${lookup(var.vpc_az_shortname,var.vpc_az_list[0])}-appliance" }
}

resource "aws_subnet" "public_subnet_az_0"{
  vpc_id            = aws_vpc.this.id
  cidr_block        = cidrsubnet(local.az_a, 6, 2)
  availability_zone = var.vpc_az_list[0]
  tags              = { Name = "tfp-${var.env}-net-vpc-${lookup(var.vpc_az_shortname,var.vpc_az_list[0])}-public" }
}

resource "aws_subnet" "transit_subnet_az_1" {
  vpc_id            = aws_vpc.this.id
  cidr_block        = cidrsubnet(local.az_b, 6, 0)
  availability_zone = var.vpc_az_list[1]
  tags              = { Name = "tfp-${var.env}-net-vpc-${lookup(var.vpc_az_shortname,var.vpc_az_list[1])}-transit" }
}
resource "aws_subnet" "appliance_subnet_az_1" {
  vpc_id            = aws_vpc.this.id
  cidr_block        = cidrsubnet(local.az_b, 6, 1)
  availability_zone = var.vpc_az_list[1]
  tags              = { Name = "tfp-${var.env}-net-vpc-${lookup(var.vpc_az_shortname,var.vpc_az_list[1])}-appliance" }
}

resource "aws_subnet" "public_subnet_az_1" {
  vpc_id            = aws_vpc.this.id
  cidr_block        = cidrsubnet(local.az_b, 6, 2)
  availability_zone = var.vpc_az_list[1]
  tags              = { Name = "tfp-${var.env}-net-vpc-${lookup(var.vpc_az_shortname,var.vpc_az_list[1])}-public" }
}

===== FILE: ./modules/inspection/main.tf =====


===== FILE: ./modules/inspection/variables.tf =====
variable "env" {
  description = "The environment for which the inspection module is being configured."
  type        = string  
}
variable "vpc_region" {
  description = "The AWS region where the VPC is located."
  type        = string
}
variable "vpc_region_shortname" {
  description = "Short names for the AWS regions."
  type        = map(string)
  default     = {
    "eu-west-2" = "euw2"
  }
}

variable "vpc_az_list" {
  description = "CIDR block for the inspection VPC."
  type        = list
  default     = ["eu-west-2a", "eu-west-2b"]
}

variable "vpc_az_shortname" {
  description = "Short names for the availability zones used in the VPC."
  type        = map(string)
  default     = {
    "eu-west-2a" = "euw2a"
    "eu-west-2b" = "euw2b"
  }
}

variable "vpc_cidr_block" {
  description = "CIDR block for the inspection VPC."
  type        = string
}

